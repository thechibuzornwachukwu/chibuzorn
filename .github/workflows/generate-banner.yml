name: Generate README banner GIF

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # nightly at 02:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install npm deps for scripts
        working-directory: ./scripts
        run: npm ci --silent

      - name: Run frame capture
        working-directory: ./scripts
        run: npm run generate-frames

      - name: Install gifsicle
        run: sudo apt-get update && sudo apt-get install -y gifsicle

      - name: Create assets dir
        run: mkdir -p assets

      - name: Build GIF from frames
        run: |
          # combine frames into a looping GIF with gifsicle
          gifsicle --delay=6 --loop --colors 256 scripts/frames/frame-*.png > assets/banner.gif

      - name: Commit banner.gif
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git add assets/banner.gif || true
          git commit -m "chore: update README banner.gif" || echo "no changes to commit"
          git push
